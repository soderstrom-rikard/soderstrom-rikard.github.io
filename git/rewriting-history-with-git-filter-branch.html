<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Rewriting history with git filter-branch &#8212; soderstrom-rikard.github.io 1.0.rc1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <script src="../_static/documentation_options.js?v=9786201b"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="../linux/index.html" />
    <link rel="prev" title="Publishing sphinx generated documents on github" href="publishing-sphinx-generated-docs-on-github-pages.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="rewriting-history-with-git-filter-branch">
<h1>Rewriting history with git filter-branch<a class="headerlink" href="#rewriting-history-with-git-filter-branch" title="Link to this heading">¶</a></h1>
<p>Git has a great manual entry <a class="footnote-reference brackets" href="#git-filter-branch-manual" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> for how to use <code class="docutils literal notranslate"><span class="pre">filter-branch</span></code> and since I’m bad at naming things,
this guide is actually about something more concrete than simply rewriting history with git <code class="docutils literal notranslate"><span class="pre">filter-branch</span></code>.</p>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h2>
<p>At work, we had this repository that had aged badly and literally everything was bunched together with no thought of code separation.
Sure it’s easy to be lazy and place everything in one place, even if they have nothing to do with each other, like for example two separate
applications. Well, alright they may be related, maybe there is an API that allows direct communication between the two, but that really
isn’t a good enough reason to place them together. In this situation, what you do want is repository hierarchy, with a parent repository
that keeps track of all compatible versions of its children compatible.</p>
<p>Of course, the repository used at work was confidential so cannot reference it here. Instead I will use a “highly random” open source
project as reference, my personal favorite, the Linux kernel. Not that I am insinuating that the kernel needs to be broken down into
smaller pieces.</p>
</section>
<section id="clone-a-repo-to-break-apart">
<h2>Clone a repo to break apart<a class="headerlink" href="#clone-a-repo-to-break-apart" title="Link to this heading">¶</a></h2>
<p>Okay let us get started already.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git<span class="w"> </span>breakable-repository
</pre></div>
</div>
</section>
<section id="purge-repository-by-pathspec">
<h2>Purge repository by pathspec<a class="headerlink" href="#purge-repository-by-pathspec" title="Link to this heading">¶</a></h2>
<p>The problem at work, also have a problem with structure, trees that can potentially intersect with one another. So I needed a way to tell
<code class="docutils literal notranslate"><span class="pre">filter</span> <span class="pre">branch</span></code> that I only want these directories and these files, therefor <code class="docutils literal notranslate"><span class="pre">--subdirectory-filter</span></code> will not work. We need to be able
to express us more precise that a simple directory.</p>
<section id="brace-expansion-for-pathspecs">
<h3>Brace expansion for PATHSPECs<a class="headerlink" href="#brace-expansion-for-pathspecs" title="Link to this heading">¶</a></h3>
<p>First we need a way to handle brace expansion <a class="footnote-reference brackets" href="#bash-brace-expansion" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> in a <code class="docutils literal notranslate"><span class="pre">PATHSPEC</span></code></p>
<p>So what is a branch expansion, let us take a look at it using echo</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple</span>
<span class="nb">echo</span><span class="w"> </span>a<span class="o">{</span>,b<span class="o">}</span>
a<span class="w"> </span>ab

<span class="c1"># Nested</span>
<span class="nb">echo</span><span class="w"> </span>a<span class="o">{</span>,b<span class="o">{</span>,c<span class="o">}}</span>
a<span class="w"> </span>ab<span class="w"> </span>abc

<span class="c1"># Multiple nested</span>
<span class="nb">echo</span><span class="w"> </span>a<span class="o">{</span>,b<span class="o">{</span>,c<span class="o">}</span>d<span class="o">{</span>,e<span class="o">{</span>,f<span class="o">}}}</span>g
ag<span class="w"> </span>abdg<span class="w"> </span>abdeg<span class="w"> </span>abdefg<span class="w"> </span>abcdg<span class="w"> </span>abcdeg<span class="w"> </span>abcdefg
</pre></div>
</div>
<p>So essentially we need away to replace the space between these expansions with the or of a regular expression, for <code class="docutils literal notranslate"><span class="pre">grep</span></code> without the
<code class="docutils literal notranslate"><span class="pre">-e</span></code> flag this is <code class="docutils literal notranslate"><span class="pre">\|</span></code>. The stream editor <code class="docutils literal notranslate"><span class="pre">sed</span></code> <a class="footnote-reference brackets" href="#sed" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> to the rescue with the expression <code class="docutils literal notranslate"><span class="pre">s/</span> <span class="pre">/\\\|/g</span></code>.</p>
<p>Putting it all together, we need</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PATHSPEC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>a<span class="o">{</span>,b<span class="o">{</span>,c<span class="o">}</span>d<span class="o">{</span>,e<span class="o">{</span>,f<span class="o">}}}</span>g<span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$PATHSPEC</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/ /\/\|/g&#39;</span>
ag/<span class="p">|</span>abdg/<span class="p">|</span>abdeg/<span class="p">|</span>abdefg/<span class="p">|</span>abcdg/<span class="p">|</span>abcdeg/<span class="p">|</span>abcdefg
</pre></div>
</div>
<p>Now we have a way to find the files to keep. At least as long as the PATHSPEC itself does not contain spaces (or repeats)</p>
</section>
<section id="listing-files-and-folders-to-remove">
<h3>Listing files and folders to remove<a class="headerlink" href="#listing-files-and-folders-to-remove" title="Link to this heading">¶</a></h3>
<p>This is probably the simplest section, this is a mere show, pipe and grep <a class="footnote-reference brackets" href="#grep" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> command. Where we will the <code class="docutils literal notranslate"><span class="pre">-v</span></code> flag to invert the
search pattern.</p>
<p>So place yourself in the <code class="docutils literal notranslate"><span class="pre">breakable-repository</span></code>, then the files to keep could for example be</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PATHSPEC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>drivers/<span class="o">{</span>Makefile,net/can/<span class="o">{</span>Makefile,spi<span class="o">}}</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$PATHSPEC</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/ /\/\|/g&#39;</span>
git<span class="w"> </span>ls-files<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$PATHSPEC</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/ /\\\|/g&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>As you may notice, the result may not be exactly what we wanted. Since the pattern <code class="docutils literal notranslate"><span class="pre">drivers/makefile</span></code> is repeated in some sub-directories.
Luckily, that is easily fixed by adding the start of string <code class="docutils literal notranslate"><span class="pre">^</span></code> (I noticed this when typing this, at work our paths did not contain
repeated patterns like these ones).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PATHSPEC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>^drivers/<span class="o">{</span>Makefile,net/can/<span class="o">{</span>Makefile,spi<span class="o">}}</span><span class="k">)</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>And the those not to keep, also since we will be performing the same regular expression many times it is a good idea to remember it before
the looping over each commit.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PATHSPEC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>^drivers/<span class="o">{</span>Makefile,net/can/<span class="o">{</span>Makefile,spi<span class="o">}}</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nv">KEEP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$PATHSPEC</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/ /\\\|/g&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
git<span class="w"> </span>ls-files<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="nv">$KEEP</span>
<span class="c1"># ... lots of files  (at time of writing, around 57k number of files) ...</span>
</pre></div>
</div>
</section>
<section id="purging-without-checkout">
<h3>Purging without checkout<a class="headerlink" href="#purging-without-checkout" title="Link to this heading">¶</a></h3>
<p>Up until now, we have only prepared us for the action. However, before we proceed, consider this; Checking out all these files, deleting
them, commit the changes and repeating the whole process for each commit will significant amount of time. Furthermore, isn’t all the data
except the new git objects that are either treelike or commits already present?</p>
<p>Yes, they are and yes we can simply skip most of that by working with the index. This is done using the <code class="docutils literal notranslate"><span class="pre">--index-filter</span></code> argument for
<code class="docutils literal notranslate"><span class="pre">filter-branch</span></code> command. But we also need to inform both the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">ls-files</span></code> and <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rm</span></code> commands to use the index, this is done by
adding the <code class="docutils literal notranslate"><span class="pre">--cached</span></code> argument.</p>
<p>So putting the first part of the puzzle together, we get.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PATHSPEC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>^drivers/<span class="o">{</span>Makefile,net/can/<span class="o">{</span>Makefile,spi<span class="o">}}</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nv">KEEP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$PATHSPEC</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/ /\\\|/g&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
git<span class="w"> </span>filter-branch<span class="w"> </span>--index-filter<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s2">&quot;git ls-files --cached | grep -v </span><span class="nv">$KEEP</span><span class="s2"> | xargs git rm --cached -qr -- &quot;</span><span class="w"> </span>HEAD
</pre></div>
</div>
<p>After a period of time, we now have a branch, purged from all unwanted files/commits, thou we did just destroy the branch we where standing
on. Therefore it is very important to remember to either make a new branch first or a complete copy of the repository before performing this
action.</p>
</section>
</section>
<section id="for-each-commit-perform-a-move-operation">
<h2>For each commit perform a move operation<a class="headerlink" href="#for-each-commit-perform-a-move-operation" title="Link to this heading">¶</a></h2>
<p>The second part is quite simple in comparison to the first, if we ignore the time to process factor.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">FROM</span><span class="o">=</span>drivers
<span class="nv">TO</span><span class="o">=</span>.
git<span class="w"> </span>filter-branch<span class="w"> </span>--tree-filter<span class="w"> </span><span class="s2">&quot;git mv -k </span><span class="nv">$FROM</span><span class="s2"> </span><span class="nv">$TO</span><span class="s2">&quot;</span><span class="w"> </span>HEAD
</pre></div>
</div>
</section>
<section id="final-script">
<h2>Final script<a class="headerlink" href="#final-script" title="Link to this heading">¶</a></h2>
<p>Now that we have all the components, we can put together a nice little snippet that will perform the action we wish.
However, if you do try this on the Linux kernel repository, you may notice it will take quite some time, i.e. approximately 3-5 hours
depending on your machine for the purging alone, however, the last part will be significantly faster due to the fact that only the commits
touching those files will be revisited.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/env sh</span>

<span class="nv">FROM</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nv">TO</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="nv">KEEP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="si">${</span><span class="p">@:</span><span class="nv">3</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/ /\\\|/g&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nv">TMPBRANCH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>mktemp<span class="w"> </span>-u<span class="w"> </span>-p<span class="w"> </span>new<span class="w"> </span>repo-XXXXX<span class="k">)</span><span class="s2">&quot;</span>

<span class="c1"># Don&#39;t mess with original branch</span>
git<span class="w"> </span>branch<span class="w"> </span>--unset-upstream
git<span class="w"> </span>branch<span class="w"> </span>-m<span class="w"> </span><span class="nv">$TMPBRANCH</span>

<span class="c1"># Remove unwanted files</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;purging branch from any files not matching PATHSPEC -- </span><span class="si">${</span><span class="p">@:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>
git<span class="w"> </span>filter-branch<span class="w"> </span>--index-filter<span class="w"> </span><span class="se">\</span>
<span class="s2">&quot;git ls-files --cached | grep -v </span><span class="nv">$KEEP</span><span class="s2"> | xargs git rm --cached -qr -- &quot;</span><span class="w"> </span>HEAD

<span class="c1"># Move files</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Rewriting history by moving files from </span><span class="nv">$FROM</span><span class="s2"> to </span><span class="nv">$TO</span><span class="s2">&quot;</span>
git<span class="w"> </span>filter-branch<span class="w"> </span>-f<span class="w"> </span>--tree-filter<span class="w"> </span><span class="s2">&quot;git mv -k </span><span class="nv">$FROM</span><span class="s2"> </span><span class="nv">$TO</span><span class="s2">&quot;</span><span class="w"> </span>HEAD
</pre></div>
</div>
<p>Hope this will help someone (or myself again) in the future.</p>
<p class="rubric">References</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="git-filter-branch-manual" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://git-scm.com/docs/git-filter-branch">https://git-scm.com/docs/git-filter-branch</a></p>
</aside>
<aside class="footnote brackets" id="bash-brace-expansion" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.gnu.org/software/bash/manual/bash.html#Brace-Expansion">https://www.gnu.org/software/bash/manual/bash.html#Brace-Expansion</a></p>
</aside>
<aside class="footnote brackets" id="sed" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.gnu.org/software/sed/manual/sed.html">https://www.gnu.org/software/sed/manual/sed.html</a></p>
</aside>
<aside class="footnote brackets" id="grep" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">4</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.gnu.org/software/grep/manual/grep.html">https://www.gnu.org/software/grep/manual/grep.html</a></p>
</aside>
</aside>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">soderstrom-rikard.github.io</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=soderstrom-rikard&repo=soderstrom-rikard.github.io&type=follow&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../chip/community.html">The C.H.I.P Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chip/embedded-linux-development.html">Embedded Linux Development on C.H.I.P</a></li>
<li class="toctree-l1"><a class="reference internal" href="autocompletion-for-custom-git-commands.html">Autocompletion for custom git commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="publishing-sphinx-generated-docs-on-github-pages.html">Publishing sphinx generated documents on github</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Rewriting history with git filter-branch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/ssh-tunneling.html">Understanding Secure Shell Tunneling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yocto/building-archlinuxarm-distro.html">Building Arch Linux ARM distribution in Yocto</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yocto/virtual-targets.html">Working with Yocto virtual targets</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">&lt;no title&gt;</a><ul>
      <li>Previous: <a href="publishing-sphinx-generated-docs-on-github-pages.html" title="previous chapter">Publishing sphinx generated documents on github</a></li>
      <li>Next: <a href="../linux/index.html" title="next chapter">&lt;no title&gt;</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Rikard Söderström.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/git/rewriting-history-with-git-filter-branch.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>